# ADR 0002: Vulnerability Gating Strategy

Date: 2025-10-13
Status: Proposed
Supersedes: None
Related: ADR 0001 (APIM Gateway)

## Context
Container images for the Claim Status API are scanned automatically by Microsoft Defender for Containers after each push to Azure Container Registry (ACR). The current pipeline gate fails the build if any High or Critical vulnerability is reported (when `VULN_FAIL_SEVERITY=High`) or only Critical when set to `Critical`. Early in a project, an aggressive gate can block delivery due to inherited base image issues; too weak a gate may allow exploitable packages into production.

We need a repeatable, transparent strategy that:
- Balances velocity and security during early development.
- Provides a roadmap to tighten standards as technical debt shrinks.
- Is automatable and auditable (logged decisions & metrics).
- Encourages prompt remediation instead of chronic waivers.

## Problem
Base images (e.g., dotnet/runtime) frequently publish CVEs that may not have immediate fixes upstream at image cut time. Failing every build on transient High items leads to gate fatigue (developers repeatedly overriding). Conversely, ignoring High vulnerabilities increases risk surface (remote code execution, privilege escalation). We require a staged approach aligned with maturity.

## Options
1. Always fail on High & Critical from day one.
   - + Strong security stance.
   - - High friction; likely frequent pipeline failures.
2. Fail only on Critical forever.
   - + Low friction.
   - - High vulnerabilities accumulate; delayed patching.
3. Phased tightening with SLO-based thresholds (Chosen).
   - + Aligns enforcement with cleanliness progress.
   - + Creates measurable target dates.
   - - Requires tracking metrics / running reports.
4. Allow per-CVE waiver file committed to repo.
   - + Traceable exceptions.
   - - Risk of waiver sprawl if no expiry.

## Decision
Adopt a phased gating model (Option 3) supplemented by time-bound waivers (subset of Option 4) for specific CVEs awaiting upstream fixes.

### Phases
| Phase | Duration (approx) | Gate Threshold | Additional Actions |
|-------|-------------------|----------------|--------------------|
| 0 (Baseline) | Weeks 0–2 | Critical only | Collect vulnerability metrics; no fail on High. |
| 1 (Stabilize) | Weeks 3–6 | High & Critical (exclude waived CVEs) | Start weekly report, begin trimming High backlog. |
| 2 (Harden) | Weeks 7+ | High & Critical (no waivers unless CVSS >= 9.0 & no vendor fix) | Add Medium tracking dashboard. |
| 3 (Optimize) | Continuous | High & Critical + New Medium > X per image triggers warning | Consider SLSA/SBOM attestations. |

### Waiver Policy
- Waiver file: `security/vuln-waivers.yaml` (future) listing: `cve`, `reason`, `expiry`, `imageDigest`.
- Expired waivers cause gate failure until updated/removed.
- Max waiver lifespan: 30 days; extensions require explicit security review.

### Metrics & Reporting
- Daily job (or pipeline step) parses latest `vulns.json` and writes summary (image:tag, counts by severity) to a dashboard or custom table.
- KPIs: High count trend (must be non-increasing over Phase 1), Mean Time To Remediate (MTTR) for Critical (target < 14 days), waiver churn rate.

## Implementation Outline
1. Add optional pipeline variables:
   - `VULN_PHASE` (0|1|2|3) to switch threshold logic.
   - `WAIVER_FILE_PATH` default `security/vuln-waivers.yaml`.
2. Implement script segment (future) to:
   - Load vulnerabilities JSON.
   - Filter out CVEs listed in valid waivers (non-expired, matching digest/tag).
   - Recompute counts and apply gate rule for current `VULN_PHASE`.
3. Artifact retention: publish `vulns.json` + filtered summary for audit.
4. Add a weekly scheduled pipeline to fail if any expired waivers remain.
5. Publish an internal dashboard (Workbook) showing severity trends.

## Consequences
Positive:
- Predictable tightening; reduces early friction.
- Auditable exception handling.
- Discourages indefinite waivers through expirations.

Negative:
- Slight complexity increase in pipeline scripting.
- Requires process discipline (updating waiver file, reviewing metrics).
- Phase drift risk if dates not actively managed.

## Risks & Mitigations
| Risk | Mitigation |
|------|------------|
| Waiver sprawl | Enforce expiry & weekly report listing expiring waivers. |
| False positives block pipeline | Allow temporary downgrade to previous phase with security sign-off. |
| Metrics not visible | Automate publication to shared dashboard channel. |
| High backlog persists | Set remediation OKRs; escalate recurring offenders. |

## Future Enhancements
- Integrate SBOM generation (Syft/CycloneDX) & sign with Cosign; correlate CVEs directly with SBOM components.
- Add OpenAPI diff + SAST results into a unified security quality gate.
- Emit SARIF vulnerabilities for central aggregation.
- Tie gating phase advancement to compliance of defined SLOs (e.g., High < 3 for 2 consecutive weeks).

## Status
Implementation to begin after agreement from security + platform leads. Upon adoption, update Status to Accepted and add `security/vuln-waivers.yaml` template.
